<!doctype html><html lang=en><head><title>Entity Framework Migrations from GitHub Actions · Mabster.NET</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Matt Hamilton"><meta name=description content="So you have an app using Entity Framework that you&rsquo;re deploying using GitHub Actions, and you want to use Migrations to keep your database up to date."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mabster.net/images/thumbnail.png"><meta name=twitter:title content="Entity Framework Migrations from GitHub Actions"><meta name=twitter:description content="So you have an app using Entity Framework that you’re deploying using GitHub Actions, and you want to use Migrations to keep your database up to date."><meta property="og:url" content="https://mabster.net/posts/ef-migration-github-actions/"><meta property="og:site_name" content="Mabster.NET"><meta property="og:title" content="Entity Framework Migrations from GitHub Actions"><meta property="og:description" content="So you have an app using Entity Framework that you’re deploying using GitHub Actions, and you want to use Migrations to keep your database up to date."><meta property="og:locale" content="en_au"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-26T09:00:00+10:00"><meta property="article:modified_time" content="2022-08-26T09:00:00+10:00"><meta property="article:tag" content="Entity-Framework"><meta property="article:tag" content="Github-Actions"><meta property="og:image" content="https://mabster.net/images/thumbnail.png"><link rel=canonical href=https://mabster.net/posts/ef-migration-github-actions/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d2c30c1af12cdd8076f3339a362c62a637de1b15fd0b9f6b0ed2f6e06fbe1d7c.css integrity="sha256-0sMMGvEs3YB28zOaNixipjfeGxX9C59rDtL24G++HXw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.1f9882ae5be1d5a9f377e2ddf450e2bf1b8493f2e8354db91cf21834f790371a.css integrity="sha256-H5iCrlvh1anzd+Ld9FDivxuEk/LoNU25HPIYNPeQNxo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.82314e159b01e3d46353bd31e035fe64ca87253f10f259c8ae306fcc8f68fe8d.css integrity="sha256-gjFOFZsB49RjU70x4DX+ZMqHJT8Q8lnIrjBvzI9o/o0=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/favicon-32x32.png><link rel=apple-touch-icon sizes=180x180 href=/images/favicon-32x32.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://mabster.net/>Mabster.NET
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title style=view-transition-name:post-title-ef-migration-github-actions><a class=title-link href=https://mabster.net/posts/ef-migration-github-actions/>Entity Framework Migrations from GitHub Actions</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-08-26T09:00:00+10:00>26 Aug 2022
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read
</span><span><a href=https://github.com/mabster/mabster.github.io/tree/main/content/posts/ef-migration-github-actions.md><i class="fa fa-github"></i> View on GitHub</a></span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/entity-framework/>Entity-Framework</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/github-actions/>Github-Actions</a></span></div></div></header><div class=post-content><div style=view-transition-name:post-summary-ef-migration-github-actions><p>So you have an app using Entity Framework that you&rsquo;re deploying using GitHub Actions, and you want to use Migrations to keep your database up to date.</p></div><p>But there might be several reasons why you don&rsquo;t want your app to apply the migrations (as described in the <a href="https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/applying?tabs=dotnet-core-cli#apply-migrations-at-runtime" class=external-link target=_blank rel=noopener>Apply Migrations at Runtime</a> section of the documentation). My two favourite reasons are:</p><ul><li>You only want your application to have db_datareader/db_datawriter access to your database, so it can&rsquo;t make schema changes</li><li>Your app might be running in multiple places and you don&rsquo;t want to risk two instances both trying to apply a migration concurrently</li></ul><p>And honestly, it just doesn&rsquo;t <em>feel right</em> to have the app in charge of the database schema. The <em>deployment</em> mechanism should be the thing ensuring that dependencies, of which the database is one, are all correctly set up.</p><p>With that in mind it makes sense to apply database migrations from your GitHub Actions workflow, if that&rsquo;s what you&rsquo;re using to deploy your app. So let&rsquo;s do that!</p><p>We&rsquo;ll assume that you already have a GitHub Action to build and deploy your app.</p><h2 id=install-ef-tool>Install EF Tool
<a class=heading-link href=#install-ef-tool><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The first thing you&rsquo;ll need to do in your GitHub action, after the &ldquo;Set up .NET&rdquo; step, is to install the Entity Framework command line tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install EF Tool</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dotnet new tool-manifest
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dotnet tool install dotnet-ef</span>
</span></span></code></pre></div><p>So now we have the <code>dotnet ef migrations</code> command at our disposal.</p><h2 id=generate-migration-bundle>Generate Migration Bundle
<a class=heading-link href=#generate-migration-bundle><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Next up, after your build/publish step, you&rsquo;ll want to generate the migration. There are several ways to do this, but I&rsquo;m using &ldquo;bundles&rdquo;, which generates an exe that can apply the migration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate EF migration script</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>dotnet ef migrations bundle --startup-project MyApp --output ${{env.DOTNET_ROOT}}/myapp/efbundle.exe --configuration Bundle</span>
</span></span></code></pre></div><div class="notice note"><div class=notice-title><i class="fa-solid fa-sticky-note" aria-hidden=true></i>Note</div><div class=notice-content>You&rsquo;ll notice the <code>--configuration Bundle</code> on the end there. That&rsquo;s a hack to work around <a href=https://github.com/dotnet/efcore/issues/25555 class=external-link target=_blank rel=noopener>this issue</a>, which I really hope is fixed in the EF 7 release. What you <em>should</em> be able to do, since you just finished building the solution, is pass <code>--configuration Release</code> and <code>--no-build</code> so it uses the already-built binaries to create the bundle.</div></div><p>If you&rsquo;re more SQL-script oriented, you might instead like to generate an idempotent script, which you can do like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate EF migration script</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>run</span>: <span style=color:#ae81ff>dotnet ef migrations script --idempotent --startup-project MyApp --output ${{env.DOTNET_ROOT}}/myapp/migrate.sql</span>
</span></span></code></pre></div><p>In both cases, we&rsquo;re dropping the bundle (be it an exe or an SQL script) into the <code>${{env.DOTNET_ROOT}}/myapp</code> folder, so it will be part of the deployable artifact of our app. That&rsquo;s useful if you have separate &ldquo;build&rdquo; and &ldquo;deploy&rdquo; jobs in your yaml file.</p><p>We&rsquo;ll talk about the different ways to apply these migrations next.</p><h2 id=apply-the-migration>Apply the Migration
<a class=heading-link href=#apply-the-migration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now that your migration is built and ready to apply, let&rsquo;s apply it!</p><p>You&rsquo;ll need a GitHub secret, which I&rsquo;ve called <code>MY_CONNECTION_STRING</code> in these examples, to tell the action how to connect to your database. Remember that the credentials in that connection string will need enough access to your database to make schema changes!</p><p>For a bundle executable, this step will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Apply EF migration script</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>./efbundle.exe --connection &#34;${{ secrets.MY_CONNECTION_STRING }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># or ./myapp/efbundle.exe if you&#39;re in the same job as the build</span>
</span></span></code></pre></div><p>So that just runs the <code>efbundle.exe</code> command that we generated in a previous step, and passes it that secret connection string.</p><p>For an idempotent SQL script, the step will look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Apply EF migration script</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>Azure/sql-action@v1.2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>connection-string</span>: <span style=color:#ae81ff>${{ secrets.MY_CONNECTION_STRING }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>sql-file</span>: <span style=color:#ae81ff>./migrate.sql</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># or ./myapp/migrate.sql if you&#39;re in the same job as the build</span>
</span></span></code></pre></div><p>So this is using the Microsoft-maintained <code>Azure/sql-action</code> step, passing it our connection string and the script we created earlier. I&rsquo;ve not been able to use this technique yet, because the db_owner user in my connection string only exists in my app&rsquo;s database, but the sql-action step requires access to the master database on your server. That will change in v2 of the action, due out soon.</p><p>You&rsquo;ll want to have this step happen before the actual deployment of your app, so you&rsquo;re not deploying the app if something goes wrong with the migration.</p><p>And there you have it! Create your migration and apply it within your GitHub Actions workflow!</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2025
Matt Hamilton
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>